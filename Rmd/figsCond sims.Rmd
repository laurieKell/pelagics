---
# FigsCond simple.Rmd
#
# Simplified!
#
# title: "**Pelagics**"
# subtitle: "Operating Model Conditioning"
# author: "L Kell"
# date: "`r format(Sys.time(), '%d %B, %Y')`"
# output: html_document
output:
  word_document:
    reference_docx: ../report_template.dotx
mathjax: TRUE
# fig_width: 6 
# fig_height: 4 
# tags: FLR FLCore introduction
# license: Creative Commons Attribution-ShareAlike 4.0 International Public License
# bibliography: refs.bib
---


```{r, knitr, echo=FALSE, fig.asp=1.15, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}
library(knitr)

knitr::opts_chunk$set(
               cache     =TRUE, 
               comment   ="", 
               warning   =FALSE, 
               message   =FALSE, 
               error     =FALSE, 
               echo      =FALSE, 
               eval      =TRUE,
               crop      =TRUE,
               cache.path="../cache/figs/cond/",
               fig.path  ="../tex/figs",
               fig.width =10,
               fig.height=8,
               dev       ="png")

rm(list=ls())

iFig=0
iTab=0
nits=100

library(FLCore) 
library(ggplotFL)
library(FLfse)
library(FLBRP)
library(FLasher)
library(FLAssess)
library(FLSAM)
library(kobe)   
library(mpb)    

library(rjson) # install.packages("rjson"); used for dropbox function
library(RJSONIO)

library(TMB)
library(stockassessment)
  
library(plyr)
library(dplyr)
library(tidyr)
library(reshape)
library(magrittr)
library(ggpubr)
  
library(grid) 
library(ggpubr)

library(compositions) 

theme_set(theme_bw(16))

source('../R/kobe-phaseMar.R')
source('../R/kobe-phase.R')
source('../R/get_dropbox.r')
source("../R/pm.R")

dropboxdir<-try(file.path(get_dropbox(), "pelagics"))

if ("try-error"%in%is(dropboxdir))
  dropboxdir="~/Dropbox/pelagics"


# reference points
refs <-
  read.csv(file.path(dropboxdir,"data/inputs/refs.csv"),header=T) %>% 
  mutate(across(c("flim","fpa","fmsy","fcap","blim","bpa","msybtrigger"), as.numeric)) %>% 
  tidyr::pivot_longer(names_to = "refpoint", values_to = "data", c("flim","fpa","fmsy","fcap","blim","bpa","msybtrigger")) %>% 
  drop_na(data) %>% 
  dplyr::mutate(stk    = substr(stockkeylabelold,1,3)) %>%
  dplyr::mutate(qname  = ifelse(grepl("^f", refpoint), "fbar","ssb")) %>% 
  dplyr::rename(year = assessmentyear) %>% 
  dplyr::mutate(reftype = dplyr::case_when(
    grepl("lim", refpoint)  ~ "lim",
    grepl("pa", refpoint)   ~ "pa",
    grepl("msy", refpoint)  ~ "msy",
    NA                      ~ ""
  )) %>% 
  dplyr::select(spp, stk, year, refpoint, reftype, data, qname) 

reload <- FALSE

if(reload) {
  # load and run by stock
  combY <- combI <- data.frame(stringsAsFactors = FALSE)
  
  for (mystk in c("whb","her","mac")) {
  
    load(file.path(dropboxdir,paste0("data/runs/",mystk,".RData")))   # sims
  
    combY <-
      bind_rows(
      combY, 
      ldply(sims, function(x) as.data.frame(pmYear(window(x[[1]], start=2001)),drop=T)) %>% mutate(stk=mystk) 
    )  
    
    combI <-
      bind_rows(
      combI, 
      ldply(sims, function(x) model.frame(pmIter(window(x[[1]], start=2001)))) %>% mutate(stk=mystk) 
    )  
  }

  save(combY, combI,
       file=file.path(dropboxdir,paste0("data/runs/","comb_df",".RData")))
  
} else {

  load(file=file.path(dropboxdir,paste0("data/runs/","comb_df",".RData")))  
  
}

```

# Hindcast analysis of pelagic stocks

## Blue whiting, North Sea herring and Northeast Atlantic mackerel

**L. Kell, M.A. Pastoors

`r format(Sys.time(), '%d/%m/%Y')`



## Simulation results


### Blue whiting


```{r, runWhb1, echo=FALSE, fig.asp=1.15, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

mystk     <- "whb"
myvar     <- c("catch","cCum", "ssb","fbar", "aav", "aav2")
scenarios <- c("ICES", "Fmsy", "HCR1")
rp        <- refs  %>% filter(stk == mystk, refpoint %in% c("fmsy", "blim", "msybtrigger"))
ices      <- combY %>% filter(stk == mystk, qname %in% c(myvar),  .id %in% "ICES",  year %in% 2000:2021) %>% dplyr::select(- .id)
df        <- combY %>% filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021) %>% 
  mutate(.id = factor(.id, levels=scenarios)) 
  
df %>% 
  ggplot(aes(x=year, y=median)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),  
        panel.border     = element_rect(linetype = 1, colour="black", fill=NA))+

  geom_line(aes(y=median), 
            linewidth=1, colour="red") +
  geom_ribbon(aes(xmin=year, xmax=year, ymin=lowq, ymax=uppq), 
              alpha=0.2, fill="red") +
  # ICES
  geom_line(data= ices, aes(year,median), 
            col="blue", linewidth=1, linetype=2, inherit.aes=FALSE) +
  
  # refpoints
  geom_line(data=rp, 
            aes(x=year, y=data, group=reftype, col=reftype),
            linewidth=1, linetype=3) +
  
  expand_limits(y=0) +
  facet_grid(qname ~ .id, scales="free_y")



```

\newpage

```{r, runWhb2, echo=FALSE, fig.asp=1.15, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

mystk     <- "whb"
myvar     <- c("catch","cCum", "ssb","fbar")
scenarios <- c("ICES","HCR1",  "HCR1 bnd", "HCR2 bnd")
rp        <- refs %>% filter(stk == mystk, refpoint %in% c("fmsy", "blim", "msybtrigger"))
ices      <- combY %>% filter(stk == mystk, qname %in% c(myvar),  .id %in% "ICES",  year %in% 2000:2021) %>% dplyr::select(- .id)
df        <- combY %>% filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021) %>% 
  mutate(.id = factor(.id, levels=scenarios)) 
  
df %>% 
  ggplot(aes(x=year, y=median)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),  
        panel.border     = element_rect(linetype = 1, colour="black", fill=NA))+

  geom_line(aes(y=median), 
            linewidth=1, colour="red") +
  geom_ribbon(aes(xmin=year, xmax=year, ymin=lowq, ymax=uppq), 
              alpha=0.2, fill="red") +
  # ICES
  geom_line(data= ices, aes(year,median), 
            col="blue", linewidth=1, linetype=2, inherit.aes=FALSE) +
  
  # refpoints
  geom_line(data=rp, 
            aes(x=year, y=data, group=reftype, col=reftype),
            linewidth=1, linetype=3) +
  
  expand_limits(y=0) +
  facet_grid(qname ~ .id, scales="free_y")



```

\newpage


```{r, runWhb3, echo=FALSE, fig.asp=1.15, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

mystk     <- "whb"
myvar     <- c("catch","cCum", "ssb","fbar")
scenarios <- c("HCR1", "HCR1 +10%", "HCR1 +20%", "HCR1 +30%")
rp        <- refs %>% filter(stk == mystk, refpoint %in% c("fmsy", "blim", "msybtrigger"))
ices      <- combY %>% filter(stk == mystk, qname %in% c(myvar),  .id %in% "ICES",  year %in% 2000:2021) %>% dplyr::select(- .id)
df        <- combY %>% filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021) %>% 
  mutate(.id = factor(.id, levels=scenarios)) 
  
df %>% 
  ggplot(aes(x=year, y=median)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),  
        panel.border     = element_rect(linetype = 1, colour="black", fill=NA))+

  geom_line(aes(y=median), 
            linewidth=1, colour="red") +
  geom_ribbon(aes(xmin=year, xmax=year, ymin=lowq, ymax=uppq), 
              alpha=0.2, fill="red") +
  # ICES
  geom_line(data= ices, aes(year,median), 
            col="blue", linewidth=1, linetype=2, inherit.aes=FALSE) +
  
  # refpoints
  geom_line(data=rp, 
            aes(x=year, y=data, group=reftype, col=reftype),
            linewidth=1, linetype=3) +
  
  expand_limits(y=0) +
  facet_grid(qname ~ .id, scales="free_y")

```

\newpage


```{r, runWhb4, echo=FALSE, fig.asp=1.15, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

mystk     <- "whb"
myvar     <- c("catch","cCum", "ssb","fbar", "aav")
scenarios <- c("HCR1 +10%", "HCR1 +10% bnd", "HCR1 +10% bnd cap", "HCR1 +random bnd", "HCR1 +random bnd recent")
rp        <- refs %>% filter(stk == mystk, refpoint %in% c("fmsy", "blim", "msybtrigger"))
ices      <- combY %>% filter(stk == mystk, qname %in% c(myvar),  .id %in% "ICES",  year %in% 2000:2021) %>% dplyr::select(- .id)
df        <- combY %>% filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021) %>% 
  mutate(.id = factor(.id, levels=scenarios)) 
  
df %>% 
  ggplot(aes(x=year, y=median)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),  
        panel.border     = element_rect(linetype = 1, colour="black", fill=NA))+

  geom_line(aes(y=median), 
            linewidth=1, colour="red") +
  geom_ribbon(aes(xmin=year, xmax=year, ymin=lowq, ymax=uppq), 
              alpha=0.2, fill="red") +
  # ICES
  geom_line(data= ices, aes(year,median), 
            col="blue", linewidth=1, linetype=2, inherit.aes=FALSE) +
  
  # refpoints
  geom_line(data=rp, 
            aes(x=year, y=data, group=reftype, col=reftype),
            linewidth=1, linetype=3) +
  
  expand_limits(y=0) +
  facet_grid(qname ~ .id, scales="free_y")

```

```{r, check, echo=FALSE, fig.asp=.4, fig.align="center", message=FALSE, warning=FALSE, cache=FALSE}

mystk     <- "whb"
myvar     <- c("catch")
scenarios <- c("ICES", "HCR1 bnd", "HCR1 +10%", "HCR1 +10% bnd", "HCR1 +10% bnd cap")
rp        <- refs %>% filter(stk == mystk, refpoint %in% c("fmsy", "blim", "msybtrigger"))
ices      <- combY %>% filter(stk == mystk, qname %in% c(myvar),  .id %in% "ICES",  year %in% 2000:2021) %>% dplyr::select(- .id)
df        <- combY %>% filter(stk == mystk, qname %in% c(myvar),  .id %in% scenarios, year %in% 2000:2021) %>% 
  mutate(.id = factor(.id, levels=scenarios)) %>% 
  group_by(.id) %>% 
  mutate(perc_diff = (median-lag(median))/lag(median)) 
  
df %>% 
  ggplot(aes(x=year, y=perc_diff)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),  
        panel.border     = element_rect(linetype = 1, colour="black", fill=NA))+

  geom_line(linewidth=1, colour="red") +
  geom_hline(yintercept = 0.25, colour="black", linewidth=1, linetype=2) +
  geom_hline(yintercept = -0.2, colour="black", linewidth=1, linetype=2) +
  expand_limits(y=0) +
  facet_grid(qname ~ .id, scales="free_y")

```
